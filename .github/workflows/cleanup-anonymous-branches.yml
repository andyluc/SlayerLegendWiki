name: Cleanup Anonymous Edit Branches

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to delete branches
      pull-requests: read # Required to check for open PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all branches

      - name: Delete closed anonymous edit branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          REPO="${{ github.repository }}"
          echo "üîç Searching for anonymous-edit branches in $REPO..."

          # Get all branches starting with anonymous-edit/
          BRANCHES=$(gh api repos/$REPO/branches --paginate --jq '.[] | select(.name | startswith("anonymous-edit/")) | .name')

          if [ -z "$BRANCHES" ]; then
            echo "‚úÖ No anonymous-edit branches found. Nothing to clean up."
            exit 0
          fi

          BRANCH_COUNT=$(echo "$BRANCHES" | wc -l)
          echo "üìã Found $BRANCH_COUNT anonymous-edit branch(es)"

          DELETED_COUNT=0
          SKIPPED_COUNT=0

          # Check each branch for open PRs
          while IFS= read -r BRANCH; do
            echo ""
            echo "üîé Checking branch: $BRANCH"

            # Check if branch has an open PR
            OPEN_PRS=$(gh pr list --repo $REPO --head "$BRANCH" --state open --json number --jq 'length')

            if [ "$OPEN_PRS" -gt 0 ]; then
              echo "  ‚è≠Ô∏è  Skipping - has $OPEN_PRS open PR(s)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            else
              echo "  üóëÔ∏è  Deleting branch (no open PRs)..."
              gh api repos/$REPO/git/refs/heads/$BRANCH -X DELETE || {
                echo "  ‚ö†Ô∏è  Failed to delete branch"
                continue
              }
              echo "  ‚úÖ Deleted successfully"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done <<< "$BRANCHES"

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Cleanup Summary:"
          echo "   ‚Ä¢ Branches found: $BRANCH_COUNT"
          echo "   ‚Ä¢ Branches deleted: $DELETED_COUNT"
          echo "   ‚Ä¢ Branches skipped: $SKIPPED_COUNT"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
