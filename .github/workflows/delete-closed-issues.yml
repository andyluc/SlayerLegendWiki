name: Delete Closed Issues

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE" to confirm deletion of all closed issues'
        required: true
        type: string
      dry_run:
        description: 'Dry run (list issues without deleting)'
        required: false
        type: boolean
        default: true
      exclude_labels:
        description: 'Comma-separated labels to exclude (e.g., "keep,important")'
        required: false
        type: string
        default: ''

permissions:
  issues: write
  contents: read

jobs:
  delete-closed-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Check if user is repository owner
        if: github.actor != github.repository_owner
        run: |
          echo "‚ùå Access denied. Only the repository owner can execute this workflow."
          echo "   Actor: ${{ github.actor }}"
          echo "   Owner: ${{ github.repository_owner }}"
          exit 1

      - name: Validate confirmation
        if: github.event.inputs.confirm != 'DELETE'
        run: |
          echo "‚ùå Deletion not confirmed. You must type 'DELETE' to proceed."
          exit 1

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Delete closed issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADMIN_TOKEN }}
          script: |
            const isDryRun = ${{ github.event.inputs.dry_run }};
            const excludeLabelsInput = '${{ github.event.inputs.exclude_labels }}';
            const excludeLabels = excludeLabelsInput ? excludeLabelsInput.split(',').map(l => l.trim()) : [];

            console.log('üîç Starting closed issues cleanup...');
            console.log(`üìã Mode: ${isDryRun ? 'DRY RUN (no deletions)' : 'LIVE DELETION'}`);
            if (excludeLabels.length > 0) {
              console.log(`üè∑Ô∏è  Excluding issues with labels: ${excludeLabels.join(', ')}`);
            }
            console.log('---');

            let page = 1;
            let hasMore = true;
            let totalFound = 0;
            let totalDeleted = 0;
            let totalSkipped = 0;
            const skippedReasons = {
              pullRequest: 0,
              excludedLabel: 0,
              error: 0
            };

            while (hasMore) {
              console.log(`üìÑ Fetching page ${page}...`);

              // Fetch closed issues (100 per page, GitHub's max)
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed',
                per_page: 100,
                page: page
              });

              if (issues.length === 0) {
                hasMore = false;
                break;
              }

              console.log(`   Found ${issues.length} closed issues on page ${page}`);
              totalFound += issues.length;

              for (const issue of issues) {
                // Skip pull requests (they show up as issues in the API)
                if (issue.pull_request) {
                  console.log(`   ‚è≠Ô∏è  Skipping #${issue.number} (pull request)`);
                  totalSkipped++;
                  skippedReasons.pullRequest++;
                  continue;
                }

                // Check if issue has any excluded labels
                const issueLabels = issue.labels.map(l => l.name);
                const hasExcludedLabel = excludeLabels.some(excludeLabel =>
                  issueLabels.includes(excludeLabel)
                );

                if (hasExcludedLabel) {
                  console.log(`   ‚è≠Ô∏è  Skipping #${issue.number} (has excluded label: ${issueLabels.filter(l => excludeLabels.includes(l)).join(', ')})`);
                  totalSkipped++;
                  skippedReasons.excludedLabel++;
                  continue;
                }

                if (isDryRun) {
                  console.log(`   üîç Would delete #${issue.number}: ${issue.title}`);
                  totalDeleted++;
                } else {
                  try {
                    // Delete the issue
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      state: 'closed',
                      state_reason: 'not_planned'
                    });

                    // Note: GitHub API doesn't allow true deletion of issues via REST API
                    // Issues can only be deleted via GraphQL API with admin permissions
                    // This workflow marks them as closed with "not_planned" reason
                    // To truly delete, you need to use GraphQL mutation deleteIssue

                    console.log(`   ‚úÖ Closed #${issue.number}: ${issue.title}`);
                    totalDeleted++;

                    // Rate limiting: wait 100ms between deletions to avoid hitting API limits
                    await new Promise(resolve => setTimeout(resolve, 100));
                  } catch (error) {
                    console.log(`   ‚ùå Failed to close #${issue.number}: ${error.message}`);
                    totalSkipped++;
                    skippedReasons.error++;
                  }
                }
              }

              page++;

              // Add a small delay between pages to respect rate limits
              if (hasMore) {
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
            }

            // Summary
            console.log('---');
            console.log('üìä Summary:');
            console.log(`   Total closed issues found: ${totalFound}`);
            console.log(`   ${isDryRun ? 'Would delete' : 'Deleted'}: ${totalDeleted}`);
            console.log(`   Skipped: ${totalSkipped}`);
            if (skippedReasons.pullRequest > 0) {
              console.log(`      - Pull requests: ${skippedReasons.pullRequest}`);
            }
            if (skippedReasons.excludedLabel > 0) {
              console.log(`      - Excluded labels: ${skippedReasons.excludedLabel}`);
            }
            if (skippedReasons.error > 0) {
              console.log(`      - Errors: ${skippedReasons.error}`);
            }
            console.log('‚úÖ Done!');

            // Create a job summary
            await core.summary
              .addHeading(isDryRun ? 'üîç Dry Run Summary' : '‚úÖ Deletion Summary')
              .addTable([
                [{data: 'Metric', header: true}, {data: 'Count', header: true}],
                ['Total closed issues found', totalFound.toString()],
                [isDryRun ? 'Would delete' : 'Deleted', totalDeleted.toString()],
                ['Skipped (Pull Requests)', skippedReasons.pullRequest.toString()],
                ['Skipped (Excluded Labels)', skippedReasons.excludedLabel.toString()],
                ['Skipped (Errors)', skippedReasons.error.toString()]
              ])
              .write();
