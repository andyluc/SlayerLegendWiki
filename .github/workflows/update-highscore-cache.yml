name: Update Contributor Highscore Cache

# This workflow automatically updates the contributor highscore cache
# by fetching fresh contributor statistics and storing them in a GitHub issue.
# This prevents every user from hitting the GitHub API for the same data.
#
# The cache is stored in a GitHub issue with the label "highscore-cache"
# and is read by the wiki's highscore page for all users.
#
# Schedule: Runs daily at 2 AM UTC
# Manual: Can be triggered manually via GitHub UI (Actions tab)
on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger from Actions tab

jobs:
  update-cache:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write  # Need write permission to update cache issue

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update highscore cache
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const CACHE_ISSUE_TITLE = '[Cache] Contributor Highscore';

            console.log('ðŸ” Fetching contributor statistics...');

            // Fetch contributor stats
            const { data: contributors } = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            console.log(`âœ… Found ${contributors.length} contributors`);

            // Format contributor data
            const formattedContributors = contributors.map(contributor => ({
              login: contributor.login,
              avatarUrl: contributor.avatar_url,
              contributions: contributor.contributions,
              profileUrl: contributor.html_url,
              prestige: 0
            }));

            // Sort by contributions (descending)
            formattedContributors.sort((a, b) => b.contributions - a.contributions);

            // Create cache data
            const cacheData = {
              lastUpdated: new Date().toISOString(),
              contributors: formattedContributors
            };

            console.log('ðŸ” Looking for cache issue...');

            // Find existing cache issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'highscore-cache',
              per_page: 1
            });

            let issueNumber;

            if (issues.length > 0) {
              // Update existing issue
              issueNumber = issues[0].number;
              console.log(`ðŸ“ Updating existing cache issue #${issueNumber}...`);

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: JSON.stringify(cacheData, null, 2)
              });
            } else {
              // Create new issue
              console.log('ðŸ“ Creating new cache issue...');

              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: CACHE_ISSUE_TITLE,
                body: JSON.stringify(cacheData, null, 2),
                labels: ['highscore-cache', 'automation']
              });

              issueNumber = newIssue.number;
            }

            console.log(`âœ… Cache updated successfully!`);
            console.log(`   Issue: #${issueNumber}`);
            console.log(`   Contributors: ${contributors.length}`);
            console.log(`   Top 3: ${formattedContributors.slice(0, 3).map(c => c.login).join(', ')}`);
